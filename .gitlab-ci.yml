---
# Run a single pipeline per push to avoid duplicate pipelines
workflow:
  rules:
    # Skip branch pipeline if an MR is open (MR pipeline handles it)
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    # Run MR pipeline for merge requests
    - if: $CI_MERGE_REQUEST_IID
    # Run branch pipeline for pushes without an MR
    - if: $CI_COMMIT_BRANCH

stages:
  - lint
  - test

variables:
  BUILD_IMAGES_PROJECT: cryptomilk/build-images
  FEDORA_BUILD: buildenv-fedora

code-format:
  stage: lint
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  rules:
    - if: $CI_MERGE_REQUEST_IID
  script:
    - |
      if prettier --check rpmspec/grammar.js rpmbash/grammar.js; then
        echo "prettier: OK"
      else
        for f in rpmspec/grammar.js rpmbash/grammar.js; do
          prettier "$f" > grammar.js.prettier
          diff --unified "$f" grammar.js.prettier | \
            bat --style=plain --paging=never --color=always
        done
        exit 1
      fi
    - |
      # Only check src/scanner.c (src/parser.c is generated)
      diff=$(git-clang-format --diff --commit "$CI_MERGE_REQUEST_DIFF_BASE_SHA" -- rpmspec/src/scanner.c rpmbash/src/scanner.c)
      if [ "$diff" = "no modified files to format" ] || \
         [ "$diff" = "clang-format did not modify any files" ]; then
        echo "clang-format: OK"
      else
        printf "You have introduced coding style breakages, suggested changes:\n\n"
        echo "${diff}" | bat --style=plain --paging=never --color=always
        exit 1
      fi

tree-sitter/test:
  stage: test
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  script:
    - npm --prefix rpmbash install
    - cmake -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo
    - cmake --build build
    - cmake --build build --target ts-test

check-bash-scanner:
  stage: test
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  script:
    - npm --prefix rpmbash install
    - make check-bash-scanner

validate-queries:
  stage: test
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  script:
    - npm --prefix rpmbash install
    - (cd rpmspec && tree-sitter build -o rpmspec.so && ts_query_ls check queries/)
    - (cd rpmbash && tree-sitter build -o rpmbash.so && ts_query_ls check queries/)
